<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location & Route Mapping</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
            color: #2c3e50;
        }

        h1 {
            color: #3498db;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 75vh;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        input {
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            width: 200px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .status-box {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        #current-coords {
            color: #e74c3c;
            font-weight: 600;
        }

        .distance-info {
            font-size: 1.1em;
            color: #27ae60;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <h1>üöÄ Live Location Tracker & Navigation</h1>

    <div class="controls">
        <div class="status-box">
            üìç <b>Current Position:</b> <span id="current-coords">Detecting...</span>
        </div>

        <input type="text" id="destination" placeholder="Enter Destination (lat,lng)">
        <button onclick="calculateRoute()">üó∫Ô∏è Calculate Route</button>
        <button onclick="recenterMap()">üéØ Re-center Map</button>
        <button onclick="clearMarkers()">üóëÔ∏è Clear Markers</button>

        <div class="distance-info">
            üìè Distance: <span id="distance">-</span> üïí ETA: <span id="eta">-</span>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let map = L.map('map').setView([21.145800, 79.088155], 13); // Default location: Nagpur
        let userMarker, routingControl, userLat, userLng;
        let isFirstLocation = true;
        let markers = []; // Store added markers

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Function to update user's live location
        function trackLocation(position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;

            document.getElementById("current-coords").innerHTML = `${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

            if (userMarker) {
                userMarker.setLatLng([userLat, userLng]).bindPopup("You are here!").openPopup();
                if (isFirstLocation) {
                    map.setView([userLat, userLng], 15);
                    isFirstLocation = false;
                }
            } else {
                userMarker = L.marker([userLat, userLng]).addTo(map).bindPopup("You are here!").openPopup();
                map.setView([userLat, userLng], 15);
            }
        }

        // Error handling for geolocation
        function showError(error) {
            alert("Geolocation failed. Please enable location access.");
        }

        // Function to calculate route
        function calculateRoute() {
            let destInput = document.getElementById("destination").value;

            if (!destInput) {
                alert("Please enter destination coordinates");
                return;
            }

            let [destLat, destLng] = destInput.split(",").map(coord => Number(coord.trim()));

            if (isNaN(destLat) || isNaN(destLng)) {
                alert("Invalid coordinate format");
                return;
            }

            // Remove existing route if any
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Draw new route
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLat, userLng),
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: true,
                formatter: new L.Routing.Formatter({ language: "en", units: "metric" })
            }).addTo(map);

            // Show distance and estimated time
            routingControl.on("routesfound", function (e) {
                let distanceKm = e.routes[0].summary.totalDistance / 1000; // Convert meters to km
                let estimatedTimeMin = Math.round(distanceKm / 50 * 60); // Assume avg speed 50 km/h

                document.getElementById("distance").textContent = `${distanceKm.toFixed(1)} km`;
                document.getElementById("eta").textContent = `~${estimatedTimeMin} mins`;
            });
        }

        // Function to re-center map on user's location
        function recenterMap() {
            if (userLat && userLng) {
                map.setView([userLat, userLng], 15);
            }
        }

        // Function to add a marker on map click
        function addMarker(e) {
            let newMarker = L.marker(e.latlng).addTo(map)
                .bindPopup(`üìç Marker at ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`).openPopup();
            markers.push(newMarker);
        }

        // Function to clear all markers
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // Attach click event listener to add marker
        map.on('click', addMarker);

        // Start tracking user's live location
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(trackLocation, showError, {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 27000
            });
        } else {
            alert("Geolocation not supported");
        }
    </script>

</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location & Route Mapping</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

    <style>
        #map {
            width: 100%;
            height: 75vh;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-4">
        <h1 class="text-primary text-center">ğŸš€ Live Location Tracker & Navigation</h1>

        <div class="card shadow p-4 mt-3">
            <div class="status-box mb-3">
                ğŸ“ <b>Current Position:</b> <span id="current-coords" class="text-danger fw-bold">Detecting...</span>
            </div>

            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" id="destination" class="form-control" placeholder="Enter Destination (lat,lng)">
                </div>
                <div class="col-md-6 d-grid">
                    <button class="btn btn-primary" onclick="calculateRoute()">ğŸ—ºï¸ Calculate Route</button>
                </div>
            </div>

            <div class="row g-2 mt-2">
                <div class="col-md-4 d-grid">
                    <button class="btn btn-secondary" onclick="recenterMap()">ğŸ¯ Re-center Map</button>
                </div>
                <div class="col-md-4 d-grid">
                    <button class="btn btn-danger" onclick="clearMarkers()">ğŸ—‘ï¸ Clear Markers</button>
                </div>
            </div>

            <div class="alert alert-success mt-3">
                ğŸ“ Distance: <span id="distance" class="fw-bold">-</span> ğŸ•’ ETA: <span id="eta" class="fw-bold">-</span>
            </div>
        </div>

        <div id="map" class="mt-3"></div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let map = L.map('map').setView([21.145800, 79.088155], 13); // Default: Nagpur
        let userMarker, routingControl, userLat, userLng;
        let isFirstLocation = true;
        let markers = []; // Store added markers

        // OpenStreetMap Tile Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Update User's Live Location
        function trackLocation(position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;

            document.getElementById("current-coords").innerHTML = `${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

            if (userMarker) {
                userMarker.setLatLng([userLat, userLng]).bindPopup("You are here!").openPopup();
                if (isFirstLocation) {
                    map.setView([userLat, userLng], 15);
                    isFirstLocation = false;
                }
            } else {
                userMarker = L.marker([userLat, userLng]).addTo(map).bindPopup("You are here!").openPopup();
                map.setView([userLat, userLng], 15);
            }
        }

        function showError() {
            alert("Geolocation failed. Please enable location access.");
        }

        // Calculate Route
        function calculateRoute() {
            let destInput = document.getElementById("destination").value;

            if (!destInput) {
                alert("Please enter destination coordinates");
                return;
            }

            let [destLat, destLng] = destInput.split(",").map(coord => Number(coord.trim()));

            if (isNaN(destLat) || isNaN(destLng)) {
                alert("Invalid coordinate format");
                return;
            }

            // Remove existing route
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Draw new route
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLat, userLng),
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: true,
                formatter: new L.Routing.Formatter({ language: "en", units: "metric" })
            }).addTo(map);

            // Display distance & estimated time
            routingControl.on("routesfound", function (e) {
                let distanceKm = e.routes[0].summary.totalDistance / 1000;
                let estimatedTimeMin = Math.round(distanceKm / 50 * 60);

                document.getElementById("distance").textContent = `${distanceKm.toFixed(1)} km`;
                document.getElementById("eta").textContent = `~${estimatedTimeMin} mins`;
            });
        }

        // Re-center Map
        function recenterMap() {
            if (userLat && userLng) {
                map.setView([userLat, userLng], 15);
            }
        }

        // Add Marker on Click
        function addMarker(e) {
            let newMarker = L.marker(e.latlng).addTo(map)
                .bindPopup(`ğŸ“ Marker at ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`).openPopup();
            markers.push(newMarker);
        }

        // Clear All Markers
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // Listen for map clicks to add markers
        map.on('click', addMarker);

        // Start tracking user location
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(trackLocation, showError, {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 27000
            });
        } else {
            alert("Geolocation not supported");
        }
    </script>

</body>

</html>
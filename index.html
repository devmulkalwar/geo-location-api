<script>
    let map = L.map('map').setView([21.1458, 79.0882], 13); // Default location: Nagpur
    let userMarker, routingControl, userLat, userLng;
    let markers = [];

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Function to update user's live location
    function trackLocation(position) {
        userLat = position.coords.latitude;
        userLng = position.coords.longitude;
        document.getElementById("current-coords").textContent = `${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

        if (userMarker) {
            userMarker.setLatLng([userLat, userLng]).bindPopup("You are here!").openPopup();
        } else {
            userMarker = L.marker([userLat, userLng]).addTo(map).bindPopup("You are here!").openPopup();
            map.setView([userLat, userLng], 15);
        }
    }

    // Error handling
    function showError() {
        alert("Geolocation failed. Please enable location access.");
    }

    // Function to calculate route
    function calculateRoute() {
        let destInput = document.getElementById("destination").value;
        if (!destInput) return alert("Please enter destination coordinates");

        let [destLat, destLng] = destInput.split(",").map(coord => Number(coord.trim()));
        if (isNaN(destLat) || isNaN(destLng)) return alert("Invalid coordinate format");

        // Remove existing route
        if (routingControl) map.removeControl(routingControl);

        // Draw new route
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLat, userLng),
                L.latLng(destLat, destLng)
            ],
            routeWhileDragging: true,
            createMarker: function () { return null; }, // Disable default markers
            show: false // Hide default routing UI
        }).addTo(map);

        // Show distance, ETA & route steps
        routingControl.on("routesfound", function (e) {
            let route = e.routes[0];
            let distanceKm = route.summary.totalDistance / 1000;
            let estimatedTimeMin = Math.round(distanceKm / 50 * 60);

            document.getElementById("distance").textContent = `${distanceKm.toFixed(1)} km`;
            document.getElementById("eta").textContent = `~${estimatedTimeMin} mins`;

            let stepsHtml = route.instructions.map(step => `<li>${step.text}</li>`).join("");
            document.getElementById("route-details").innerHTML = `<ul>${stepsHtml}</ul>`;
        });
    }

    // Function to re-center map
    function recenterMap() {
        if (userLat && userLng) map.setView([userLat, userLng], 15);
    }

    // Function to add a marker on map click
    function addMarker(e) {
        let newMarker = L.marker(e.latlng).addTo(map)
            .bindPopup(`ðŸ“ Marker at ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`).openPopup();
        markers.push(newMarker);
    }

    // Function to clear all markers
    function clearMarkers() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
    }

    // Attach click event listener
    map.on('click', addMarker);

    // Track user's live location
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(trackLocation, showError, {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
        });
    } else {
        alert("Geolocation not supported");
    }
</script>
